"use client";

import { useMemo, useState } from "react";

type AutoApproveResult = {
  ok?: boolean;
  message?: string;
  run_id?: number;
  rule_enabled?: boolean;
  checked_count?: number;
  approved_count?: number;
  skipped_other?: number;
  skipped_insufficient?: number;
  detail?: any;
};

function prettySummary(r: AutoApproveResult | null) {
  if (!r) return "";
  const checked = r.checked_count ?? 0;
  const approved = r.approved_count ?? 0;
  const skipIns = r.skipped_insufficient ?? 0;
  const skipOther = r.skipped_other ?? 0;

  if (checked === 0 && approved === 0 && skipIns === 0 && skipOther === 0) {
    return "Nothing to auto-approve (no pending payouts).";
  }
  return `Checked ${checked} â€¢ Approved ${approved} â€¢ Skipped (insufficient) ${skipIns} â€¢ Skipped (other) ${skipOther}`;
}

export default function DriverPayoutReportsPage() {
  const [from, setFrom] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - 7);
    return d.toISOString().slice(0, 10);
  });
  const [to, setTo] = useState(() => new Date().toISOString().slice(0, 10));
  const [status, setStatus] = useState<string>("all");
  const [limit, setLimit] = useState<number>(50);

  const [busy, setBusy] = useState(false);
  const [last, setLast] = useState<AutoApproveResult | null>(null);
  const [banner, setBanner] = useState<{ kind: "ok" | "warn" | "err"; text: string } | null>(null);

  const summary = useMemo(() => prettySummary(last), [last]);

  async function runAutoApprove() {
    try {
      setBusy(true);
      setBanner(null);

      const res = await fetch("/api/admin/driver-payouts/auto-approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ limit }),
      });

      const js = (await res.json().catch(() => ({}))) as AutoApproveResult;

      setLast(js);

      // Friendly messaging:
      if (!res.ok || js.ok === false) {
        const msg = js.message || "Auto-approve failed. Check server logs.";
        setBanner({ kind: "err", text: msg });
        return;
      }

      // rule enabled but skipped due to insufficient
      const checked = js.checked_count ?? 0;
      const approved = js.approved_count ?? 0;
      const skipIns = js.skipped_insufficient ?? 0;

      if (checked === 0) {
        setBanner({ kind: "ok", text: "Nothing to auto-approve (no pending payouts)." });
      } else if (approved === 0 && skipIns > 0) {
        setBanner({ kind: "warn", text: `No approvals: ${skipIns} pending payout(s) skipped due to insufficient wallet balance.` });
      } else {
        setBanner({ kind: "ok", text: `Auto-approve complete. Approved ${approved}. Skipped insufficient ${skipIns}.` });
      }
    } catch (e: any) {
      setBanner({ kind: "err", text: e?.message || "Auto-approve failed." });
    } finally {
      setBusy(false);
    }
  }

  return (
    <div style={{ padding: 24, maxWidth: 920 }}>
      <h1 style={{ fontSize: 22, fontWeight: 700, marginBottom: 14 }}>Driver Payout Reports</h1>

      <div style={{ border: "1px solid #e5e7eb", borderRadius: 12, padding: 16, background: "#fff" }}>
        <div style={{ display: "flex", gap: 16, alignItems: "end", flexWrap: "wrap" }}>
          <div>
            <div style={{ fontSize: 12, opacity: 0.7 }}>From</div>
            <input type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
          </div>
          <div>
            <div style={{ fontSize: 12, opacity: 0.7 }}>To</div>
            <input type="date" value={to} onChange={(e) => setTo(e.target.value)} />
          </div>
          <div>
            <div style={{ fontSize: 12, opacity: 0.7 }}>Status</div>
            <select value={status} onChange={(e) => setStatus(e.target.value)}>
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>

          <div style={{ marginLeft: "auto" }}>
            <button
              onClick={() => {
                // keep existing export behavior if you already handle it elsewhere
                // This is just a placeholder. Many teams wire export to a separate endpoint.
                alert("Export CSV: wire this to your existing export endpoint (already working in your screenshot).");
              }}
              style={{
                padding: "10px 14px",
                borderRadius: 10,
                border: "1px solid #111827",
                background: "#111827",
                color: "#fff",
                fontWeight: 600,
              }}
            >
              Export CSV
            </button>
          </div>
        </div>

        <div style={{ marginTop: 18 }}>
          <div style={{ fontSize: 14, fontWeight: 700, marginBottom: 8 }}>Auto-approve runner</div>

          <div style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" }}>
            <input
              type="number"
              value={limit}
              min={1}
              max={500}
              onChange={(e) => setLimit(Number(e.target.value || 50))}
              style={{ width: 90 }}
            />
            <button
              onClick={runAutoApprove}
              disabled={busy}
              style={{
                padding: "10px 14px",
                borderRadius: 10,
                border: "1px solid #16a34a",
                background: busy ? "#86efac" : "#22c55e",
                color: "#052e16",
                fontWeight: 800,
              }}
            >
              {busy ? "Running..." : "Run auto-approve"}
            </button>

            <div style={{ fontSize: 12, opacity: 0.7 }}>
              Approves only when rule enabled + wallet stays above minimum.
            </div>
          </div>

          {banner && (
            <div
              style={{
                marginTop: 12,
                padding: "10px 12px",
                borderRadius: 10,
                border:
                  banner.kind === "ok"
                    ? "1px solid #86efac"
                    : banner.kind === "warn"
                    ? "1px solid #fde68a"
                    : "1px solid #fecaca",
                background:
                  banner.kind === "ok"
                    ? "#ecfdf5"
                    : banner.kind === "warn"
                    ? "#fffbeb"
                    : "#fef2f2",
                color:
                  banner.kind === "ok"
                    ? "#065f46"
                    : banner.kind === "warn"
                    ? "#92400e"
                    : "#991b1b",
                fontWeight: 600,
                whiteSpace: "pre-wrap",
              }}
            >
              {banner.text}
            </div>
          )}

          {last && (
            <div style={{ marginTop: 10, fontSize: 12, opacity: 0.75 }}>
              <div>Last run: {summary}</div>
            </div>
          )}

          <div style={{ marginTop: 14, fontSize: 12, opacity: 0.85 }}>
            <div style={{ fontWeight: 700, marginBottom: 6 }}>Best-practice notes</div>
            <ul style={{ marginLeft: 18 }}>
              <li>Auto-approve runs server-side with service role only (no anon access).</li>
              <li>Skip reasons should be summarized (not raw JSON) to reduce confusion.</li>
              <li>When â€œinsufficientâ€, show one clean message: â€œInsufficient walletâ€.</li>
            </ul>
          </div>

          <div style={{ marginTop: 12, fontSize: 11, opacity: 0.6 }}>
            URL: /admin/payouts/drivers/reports
          </div>
        </div>
      </div>
    </div>
  );
}
