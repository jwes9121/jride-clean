import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function resolveBookingKey(body: any): string | null {
  return (
    body?.bookingCode ||
    body?.booking_code ||
    body?.uuid ||
    body?.id ||
    null
  );
}

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const bookingKey = resolveBookingKey(body);

    if (!bookingKey) {
      return NextResponse.json(
        { error: "MISSING_BOOKING_IDENTIFIER" },
        { status: 400 }
      );
    }

    // ---- Locate booking safely ----
    const { data: booking, error: findErr } = await supabase
      .from("bookings")
      .select("id")
      .or(
        `booking_code.eq.${bookingKey},id.eq.${bookingKey},uuid.eq.${bookingKey}`
      )
      .limit(1)
      .maybeSingle();

    if (findErr || !booking) {
      return NextResponse.json(
        { error: "BOOKING_NOT_FOUND" },
        { status: 404 }
      );
    }

    // ---- Check if is_emergency column exists ----
    const { data: colCheck } = await supabase
      .from("information_schema.columns")
      .select("column_name")
      .eq("table_schema", "public")
      .eq("table_name", "bookings")
      .eq("column_name", "is_emergency")
      .maybeSingle();

    if (colCheck?.column_name === "is_emergency") {
      // Safe to update
      const { error: updErr } = await supabase
        .from("bookings")
        .update({ is_emergency: true })
        .eq("id", booking.id);

      if (updErr) {
        return NextResponse.json(
          { error: "EMERGENCY_UPDATE_FAILED", details: updErr.message },
          { status: 500 }
        );
      }

      return NextResponse.json({
        ok: true,
        mode: "column_update",
        bookingId: booking.id,
      });
    }

    // ---- Fallback: no column exists (SAFE NO-OP) ----
    // We acknowledge emergency intent without breaking UI or schema
    return NextResponse.json({
      ok: true,
      mode: "fallback_no_column",
      bookingId: booking.id,
      note: "is_emergency column does not exist; no DB mutation performed",
    });
  } catch (e: any) {
    return NextResponse.json(
      { error: "EMERGENCY_HANDLER_FAILED", details: String(e?.message || e) },
      { status: 500 }
    );
  }
}
